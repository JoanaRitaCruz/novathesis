%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% spine.tex
%% NOVA thesis document template
%%
%% This work is licensed under the
%% The LaTeX project public license (LPPL), version 1.3c
%% To view a copy of this license, visit
%% https://www.latex-project.org/lppl/lppl-1-3c/
%%
%% Authors / Contributors:
%%      - João Lourenço <joao.lourenco@fct.unl.pt>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\typeout{NT FILE spine.tex}%

% Draw the book spine
% usable range: 145 to 425 pages, maximum characters for the title 140 and 22 for the author name
% usable range: 75 to 145 pages, maximum characters for the title 70 and 22 for the author name

\makeatletter

\tcbuselibrary{fitting}

% \input{NOVAthesisFiles/fitbox2.sty}

%-----------------------------------------------------------------
% Set author name
\spine(author)=?{\thedocauthor(name,short)}

%-----------------------------------------------------------------
% Set thesis title
\datamatch{\match}{doctitle}({\@LANG@COVER,spine,cover},{\@LANG@COVER,spine})%
\spine(title):=?{\match}

%-----------------------------------------------------------------
% set date
\spine(date)=?{\thentdocdate(submission,year)}

%-----------------------------------------------------------------
% Defaults for spine

% minimum spine width
\spine(minwidth):=?{6mm}

% order of elements in the spine
\spine(order):=?{date,title,author,logo}

% default spine orientation
\spine(angle):=?{0}

% default background color and image
\spine(bg,color):=?{none}
\spine(image):=?{none}

% default text color and alignment
\spine(text,color):=?{black}
\spine(text,align):=?{c}

% no logo by default
\spine(logo):=?{none}

% unsure what this does
\spine(order,widthskip):={}
\spine(order,widthskip):={logo,\thespine(order,widthskip)}

% default space between boxes
\spine(boxsep):=?{0.5cm}

% default frame color
\spine(frame,color):=?{}

\spine(margin,top):=?{1mm}
\spine(margin,bottom):=?{1mm}
\spine(margin,left):=?{0.5cm}
\spine(margin,right):=?{0.5cm}

%-----------------------------------------------------------------
% Defaults for spine boxes
\spine(box,margin):=?{1.0mm}
\spine(box,bg,color):=?{none}
\spine(box,text,color):=?{black}

% Defaults for spine logo boxes
\spine(box,logo,len):=?{4.1cm}
\spine(box,logo,angle)=?{0}
\spine(box,logo,align):=?{c}
\spine(box,logo,raise):=?{0pt}
\spine(box,logo,scale):=?{1}
\spine(box,logo,margin,left):=?{2pt}
\spine(box,logo,margin,right):=?{2pt}
\spine(box,logo,margin,sep):=?{1mm}

% Defaults for spine author boxes
\spine(box,author,len):=?{4.0cm}
\spine(box,author,angle)=?{\thespine(angle)}
\spine(box,author,align)=?{\thespine(text,align)}
\spine(box,author,margin,left):=?{0pt}
\spine(box,author,margin,right):=?{0pt}

% Defaults for spine title boxes
\spine(box,title,len):=?{16.7cm}
\spine(box,title,angle)=?{\thespine(angle)}
\spine(box,title,align):=?{\thespine(text,align)}
\spine(box,title,margin,left):=?{0pt}
\spine(box,title,margin,right):=?{0pt}

% Defaults for spine date boxes
\spine(box,date,len):=?{2.0cm}
\spine(box,date,angle)=?{\thespine(angle)}
\spine(box,date,align):=?{\thespine(text,align)}
\spine(box,date,margin,left):=?{0pt}
\spine(box,date,margin,right):=?{0pt}



%-----------------------------------------------------------------
\newif\ifisdim
\newcommand{\@setifisdim}[1]{%
  \StrLeft{#1}{1}[\@dimleft]%
  \StrRight{#1}{1}[\@dimright]%
  \IfInteger{\@dimleft}{%
    \IfInteger{\@dimright}{%
      % Is a number
      \isdimfalse%
    }{%
      % May be a dimension
      \isdimtrue%
    }%
  }{%
    % Is a string
    \isdimfalse%
  }%
}
\newcommand{\IfIsDim}[3]{%
  \@setifisdim{#1}%
  \ifisdim#2\else#3\fi%
}

\ifoptioncontains{/novathesis/debug}{spine}{%
  \def\@spineboxdrawopacity{1}%
  \newcommand{\DEBUG}[1]{\typeout{#1}}%
}{%
  \def\@spineboxdrawopacity{0}%
  \newcommand{\DEBUG}[1]{}%
}%

\newdimen\@spinelen  % total spine length
\newcommand{\@checkspinelen}[1][\paperheight]{%
  \@tempdima=\thespine(margin,left)\relax%
  \@tempdimb=\thespine(margin,right)\relax%
  \DEBUG{SPINELEN MARGIN [left] = \the\@tempdima}%
  \DEBUG{SPINELEN MARGIN [right] = \the\@tempdimb}%
  \@tempdima=\dimexpr\@tempdima+\@tempdimb\relax%
  \DEBUG{SPINELEN ACCUMULATED = \the\@tempdima}%
  \StrCount{\thespine(order)}{,}[\@nBoxSep]%
  % \@tempdimb=\dimexpr\thespine(boxsep)*\@nBoxSep\relax%
  % \DEBUG{SPINELEN BOXSEP [all] = \the\@tempdimb}%
  % \@tempdima=\dimexpr\@tempdima+\@tempdimb\relax%
  % \DEBUG{SPINELEN ACCUMULATED = \the\@tempdima}%
  \@for\myi:=\expanded{\thespine(order)}\do{%
    \DEBUG{SPINELEN BOXLEN [\myi]}%
    \@tempdimb=\thespine(box,\myi,len)\relax%
    \DEBUG{SPINELEN BOXLEN [\myi] = \the\@tempdimb}%
    \@tempdima=\dimexpr\@tempdima+\@tempdimb\relax%
    \DEBUG{SPINELEN ACCUMULATED = \the\@tempdima}%
  }
  \DEBUG{SPINELEN MAX = \the#1}%
  \@spinelen=\@tempdima%
}


\newcommand{\@reverelist}[2]{%
%   % #1 = list to be reversed
  \def\@rvstmp{}%
  \@for\myi:={#1}\do{%
    \epreto\@rvstmp{,\myi}%
  }%
  \edef\@rvstmp{\expandafter\@gobble\@rvstmp}%
  \edef#2{\@rvstmp}%
}


% \providecommand*{\DivideLengths}[2]{%
%   \strip@pt\dimexpr\number\numexpr\number\dimexpr#1\relax*65536/\number\dimexpr#2\relax\relax sp\relax
% }


\newcommand{\@setlength}[2]{%
  \defifundef{#1}{\newlength}%
  \@tempdima=\dimexpr#2\relax%
  \setlength{#1}{\the\@tempdima}%
}

\newcommand{\ifnotnone}[2]{%
  \IfStrEq{#1}{none}{}{#2}%
}


\newcommand{\setspinewidth}{%
  \ifdim\option{/novathesis/spine/width}=0pt\relax% user DID NOT force the spine with - calculate it
    \@tempdima=\dimexpr0.05mm * (\thelastsheet+1)\relax%
% \DEBUG{NOVATHESIS SPINE width for \thelastsheet\space pages is \the\@SPWIDTH!}%
    \ifdim\@tempdima < \thespine(minwidth)\relax% Force book spine to be at least 6mm
% \DEBUG{NOVATHESIS SPINE width was \the\@SPWIDTH, forcing to 6mm!}%
      \@tempdima=\dimexpr\thespine(minwidth)\relax%
    \fi%
  \else% user DID force the spine with - use the given width
    \@tempdima=\dimexpr\option{/novathesis/spine/width}\relax%
% \DEBUG{NOVATHESIS SPINE width user forced by user to \the\@SPWIDTH!}%
  \fi%
% \DEBUG{NOVATHESIS SPINE \string\@SPWIDTH=\the\@SPWIDTH}%
  % remove spine top and bottom margins
  \@SPWIDTH=\dimexpr\@tempdima\relax%
% \DEBUG{NOVATHESIS SPINE FINAL \string\@SPWIDTH=\the\@SPWIDTH}%
}

\newdata{boxdim}
\spine(logo)={%
	\includegraphics[height=\theboxdim(height),
									 width=\theboxdim(width),
									 keepaspectratio,
									 angle={\thespine(box,logo,\@DOCTYPE,angle)},
									 vshift=\@boxraise,
									]{\thespine(logo,\@DOCTYPE)}%
}
	
\newcommand*{\@processangle}{%
  \datamatchtf[0]{\@SPANGLE}{spine}(angle){}{}%
  \IfStrEqCase{\@SPANGLE}{
      {0}{  \def\@SPXSCALE{1}%
		        \def\@NODEANCHOR{west}%
		        \def\@GROUPANCHOR{west}%
            \def\@ROTATE{0}%
            \def\@TRANSFORMSHAPE{}%
            \ifoptionequal{/novathesis/spine/layout}{trim}{%
              \newstocksize{layoutsize={\the\paperheight,\@SPWIDTH},margin=0pt}
            }{\ifoptionequal{/novathesis/spine/layout}{notrim}{%
              \newstocksize{layoutsize={\the\paperheight,\the\paperwidth},margin=0pt}
            }{%
              \ClassError{novathesis}{Unknown page dimensions for “spine/layout=\option{/novathesis/spine/layout}”}
            }}%
         }
     {90}{  \def\@SPXSCALE{1}%
		        \def\@NODEANCHOR{west}%
		        \def\@GROUPANCHOR{south}%
            \def\@TRANSFORMSHAPE{transform shape}%
            \ifoptionequal{/novathesis/spine/layout}{trim}{%
              \newstocksize{layoutsize={\@SPWIDTH,\the\paperheight},margin=0pt}
            }{\ifoptionequal{/novathesis/spine/layout}{notrim}{%
              \newstocksize{layoutsize={\the\paperwidth,\the\paperheight},margin=0pt}
            }{%
              \ClassError{novathesis}{Unknown page dimensions for “spine/layout=\option{/novathesis/spine/layout}”}
            }}%
         }
    {180}{  \def\@SPXSCALE{-1}%
		        \def\@NODEANCHOR{east}%
		        \def\@GROUPANCHOR{east}%
            \def\@SPANGLE{0}%
            \def\@TRANSFORMSHAPE{}%
            \ifoptionequal{/novathesis/spine/layout}{trim}{%
              \newstocksize{layoutsize={\the\paperheight,\@SPWIDTH},margin=0pt}
            }{\ifoptionequal{/novathesis/spine/layout}{notrim}{%
              \newstocksize{layoutsize={\the\paperheight,\the\paperwidth},margin=0pt}
            }{%
              \ClassError{novathesis}{Unknown page dimensions for “spine/layout=\option{/novathesis/spine/layout}”}
            }}%
         }
    {270}{  \def\@SPXSCALE{1}%
		        \def\@NODEANCHOR{west}%
		        \def\@GROUPANCHOR{north}%
            \def\@SPANGLE{-90}%
            \def\@TRANSFORMSHAPE{transform shape}%
            \ifoptionequal{/novathesis/spine/layout}{trim}{%
              \newstocksize{layoutsize={\@SPWIDTH,\the\paperheight},margin=0pt}
            }{\ifoptionequal{/novathesis/spine/layout}{notrim}{%
              \newstocksize{layoutsize={\the\paperwidth,\the\paperheight},margin=0pt}
            }{%
              \ClassError{novathesis}{Unknown page dimensions for “spine/layout=\option{/novathesis/spine/layout}”}
            }}%
         }
  }[%
    \CalssError{novathesis}{Invalid spine angle: “\@SPANGLE”. Should be wither “0”, “90”, “180”, or “270”.}{}%
  ]%
}

\newcommand{\PercentToDim}[3]{%
	#1 = dimension or percentage
	#2 = base for percentage
	#3 = macro for result
	\typeout{PtD [#1] [#2] [\string#3]}
	\IfEndWith{#1}{\%}{%
		\StrGobbleRight{#1}{1}[\@PtD]%
		\edef#3{\the\dimexpr#2*\@PtD/100\relax}%
		\typeout{PtD PERC #3}
	}{\edef#3{#1}\typeout{PtD DIM #3}}%
}

\newcommand{\@ntprintspine@i}{%
  \NTRunHook{spine/pre}%
  \newlength\@SPWIDTH%
  \setspinewidth%
  \newlength\@SPHEIGHT%
  \@SPHEIGHT=\the\paperheight%
  % \@SPWIDTH=\the\paperwidth
  \spine(angle):={90}
	\@processangle%
  \newlength\@SPCURPOSX%
  \@SPCURPOSX=\dimexpr\thespine(margin,left)\relax%
  % Create a savebox
  \newsavebox\@spinebox
  % \begin{lrbox}{\@spinebox}
  \begin{tikzpicture}[remember picture, overlay,
						\@TRANSFORMSHAPE,
						rotate=\@SPANGLE,
						xscale=\@SPXSCALE,
										 ]
  % count the number of elements in the cover
  \newcount\@SPNELEM%
  % The accumulated size of all the elemnts
  \newdimen\@SPLEN
  % iterate the cover elements and draw them
  \@for\myi:=\expanded{\thespine(order)}\do{%
    \advance\@SPNELEM 1\relax%
    \@SPLEN=\dimexpr\@SPLEN+\thespine(box,\myi,len)\relax%
  }
  % Claculate the total unused (empty) space between elements
  \newdimen{\@SPUNUSEDTOTAL}%
  \@SPUNUSEDTOTAL=\dimexpr\@SPHEIGHT-\@SPLEN-\thespine(margin,left)
                                            -\thespine(margin,right)\relax%
  
  % Claculate the unused (empty) space to leave between every two elements
  \newdimen{\@SPUNUSEDSINGLE}%
  \@SPUNUSEDSINGLE=\dimexpr\@SPUNUSEDTOTAL/(\@SPNELEM-1)\relax
  % deal with debugging
  \ifoptioncontains{/novathesis/debug}{spine}{%
    \def\@boxrule{0.5pt}%
    \def\@boxcolframe{\@boxcoltext}%
    \def\@boxdebug{}%
  }{%
	\def\@boxcolframe{\@boxcoltext}%
    \def\@boxrule{0pt}%
    \def\@boxdebug{frame empty}%
  }%
  %
  % print bg image IF DEFINED
  \datamatchtf{\arg}{thesiscover}({\@DOCTYPE,spine,image},
                                  {\@DOCCLASS,spine,image},
                                  {spine,image}){%
    \ifnotnone{\arg}{%
      \node[inner sep=0,xscale=\@SPXSCALE] at (current page.center)
        {\includegraphics[width=\@SPWIDTH,height=\@SPHEIGHT,angle=-90]{\arg}};
    }}{%
      \datamatchtf{\arg}{spine}({\@DOCTYPE,image},%
                                {\@DOCCLASS,image},%
                                {image},%
    ){%
      \ifnotnone{\arg}{%
	      \node[inner sep=0,xscale=\@SPXSCALE] at (current page.center)
	        {\includegraphics[width=\@SPWIDTH,height=\@SPHEIGHT,angle=-90]{\arg}};
    }}{%
      \ClassError{novathesis}{Undefined spine “image”}{}%
    }%
  }%
  %
  % iterate the cover elements and draw them
  \@for\myi:=\expanded{\thespine(order)}\do{%
    \def\@boxcolback{tcbcolback}%
    \def\@BOXBGOPACITY{0}% Defaults to transparent box background
    \datamatchtf{\@boxcolbacki}{spine}({box,\myi,bg,color},{box,bg,color})
                  {\ifnotnone{\@boxcolbacki}{\def\@boxcolback{\@boxcolbacki}
                                            \def\@BOXBGOPACITY{1}}}{}%
    \def\@boxcoltext{.}%
		% Process RAISE option
		\datamatchtf[0pt]{\@boxraise}{spine}({box,logo,\@DOCTYPE,raise},%
															 					 {box,logo,raise},%
																				 {box,raise}%
																				){}{}%
		\PercentToDim{\@boxraise}{\the\@SPWIDTH}{\@boxraise}%
		% Process TEXT COLOR option
    \datamatchtf{\@boxcoltexti}{spine}({box,\myi,text,color},{box,text,color})
                  {\ifnotnone{\@boxcoltexti}{\def\@boxcoltext{\@boxcoltexti}}}{}%

		% Process LEFT MARGIN option
    \datamatchtf[0pt]{\@boxml}{spine}({box,\myi,\@DOCTYPE,margin,left},%
																 {box,\myi,margin,left},%
																 {box,margin,left},{box,margin}){}{}%
		\PercentToDim{\@boxml}{\the\@SPWIDTH}{\@boxml}%
		% Process RIGHT MARGIN option
    \datamatchtf[0pt]{\@boxmr}{spine}({box,\myi,\@DOCTYPE,margin,right},%
																 {box,\myi,margin,right},%
																 {box,margin,right},{box,margin}){}{}%
    \PercentToDim{\@boxmr}{\the\@SPWIDTH}{\@boxmr}%
		% Process TOP MARGIN option
    \datamatchtf[0pt]{\@boxmt}{spine}({box,\myi,\@DOCTYPE,margin,top},%
																 {box,\myi,margin,top},%
																 {box,margin,top},{box,margin}){}{}%
    \PercentToDim{\@boxmt}{\the\@SPWIDTH}{\@boxmt}%
		% Process BOTTOM MARGIN option
    \datamatchtf[0pt]{\@boxmb}{spine}({box,\myi,\@DOCTYPE,margin,bottom},%
																 {box,\myi,margin,bottom},%
																 {box,margin,bottom},{box,margin}){}{}%
    \PercentToDim{\@boxmb}{\the\@SPWIDTH}{\@boxmb}%
		% Do not fit logo
    \IfStrEq{\myi}{logo}{\def\@FIT{}}{\def\@FIT{fit}}%
    \node[inner sep=0pt, anchor=\@NODEANCHOR, %draw,
          % minimum width=\expanded{\thespine(box,\myi,usedlen)},
          % minimum height=\@SPWIDTHUSED,
          ]
      at ($(current page.\@GROUPANCHOR)+(\@SPCURPOSX,0)$) {%
                \begin{tcolorbox}[
                        size=minimal, valign=center, halign=flush center,
                        width=\expanded{\thespine(box,\myi,len)}, height=\@SPWIDTH,
                        left=\@boxml, right=\@boxmr, top=\@boxmt, bottom=\@boxmb,
                        colback=\@boxcolback, coltext=\@boxcoltext,
                        boxrule=\@boxrule, colframe=\@boxcolframe,
                        opacityback=\@BOXBGOPACITY, enhanced jigsaw,
                        \@boxdebug, \@FIT, fit fontsize macros, 
                ]%
									\boxdim(height)={\the\dimexpr\@SPWIDTH-\@boxmt-\@boxmb\relax}%
									\boxdim(width)={\the\linewidth}%
                  \renewcommand{\baselinestretch}{0.9}%
									\typeout{SPNODE[\myi]=\thespine(\myi)}%
                  \Huge\thespine(\myi)%
                \end{tcolorbox}%
      };
    \@SPCURPOSX=\dimexpr\@SPCURPOSX
                  +(\thespine(box,\myi,len)+\@SPUNUSEDSINGLE)\relax%
  }
  \end{tikzpicture}
  % \end{lrbox}
  \NTRunHook{spine/post}%
}

\newcommand{\@ntprintspine}{%
  \@ntprintspine@i%
  % W1=\the\paperwidth\quad H1=\the\paperheight\par
  % \begin{newpdflayout}{\the\paperwidth}{\the\paperheight}
    % W2=\the\paperwidth\quad H2=\the\paperheight\par
  % \begin{tikzpicture}
  %   \node[draw] at (current page.west) {\@ntprintspine@i};% {\usebox{\@spinebox}};%
  % \end{tikzpicture}
  % \@ntprintspine@i
  % \end{newpdflayout}
}


\endinput
\newcommand{\@ntprintspine}{%
  \fontsize{40}{40}\selectfont%
  \newlength\@SPWIDTH%
  \setspinewidth%
  % \@SPWIDTH=\paperwidth
  \newlength\@SPMAXLEN
  \@SPMAXLEN=\paperheight
  \newdimen{\@SPCURPOSX}%
  \spine(angle):=?{180}
  \datamatchtf[0]{\@SPANGLE}{spine}(angle){}{}%
  \IfStrEqCase{\@SPANGLE}{
      {0}{\def\@HT{\the\@SPWIDTH}\def\@WD{\the\paperheight}%
            \def\@BOXPOSITION{current page.west}%
            \def\@BOXANCHOR{west}%
            \@SPCURPOSX=\dimexpr\thespine(margin,left)\relax%
            \def\@SPXSCALE{1}%
            \def\@SPXSHIFT{0pt}%
            \def\@BOXWIDTH{\thespine(box,\myi,usedlen)}%
            \def\@BOXHEIGHT{\@SPWIDTHUSED}%
         }
     {90}{\def\@HT{\paperheight}\def\@WD{\the\@SPWIDTH}%
            \def\@BOXPOSITION{current page.south}%
            \def\@BOXANCHOR{south}%
            \@SPCURPOSX=\dimexpr\thespine(margin,left)\relax%
            \def\@SPXSCALE{1}%
            \def\@SPXSHIFT{0pt}%
            \def\@BOXWIDTH{\@SPWIDTHUSED}%
            \def\@BOXHEIGHT{\thespine(box,\myi,usedlen)}%
         }
    {180}{\def\@HT{\the\@SPWIDTH}\def\@WD{\the\paperheight}%
            \def\@BOXPOSITION{current page.west}%
            \def\@BOXANCHOR{west}%
            \@SPCURPOSX=\dimexpr\thespine(margin,left)\relax%
            \def\@SPXSCALE{-1}%
            \def\@SPXSHIFT{-\@WD}%
            \def\@BOXWIDTH{\thespine(box,\myi,usedlen)}%
            \def\@BOXHEIGHT{\@SPWIDTHUSED}%
         }
    {270}{\def\@HT{\paperheight}\def\@WD{\the\@SPWIDTH}%
            \def\@BOXPOSITION{current page.south}%
            \def\@BOXANCHOR{south}%
            \@SPCURPOSX=\dimexpr\thespine(margin,left)\relax%
            \def\@SPXSCALE{-1}%
            \def\@SPXSHIFT{-\@WD}%
            \def\@BOXWIDTH{\@SPWIDTHUSED}%
            \def\@BOXHEIGHT{\thespine(box,\myi,usedlen)}%
         }
  }[%
    \CalssError{novathesis}{Invalid spine angle: “\@SPANGLE”. Should be wither “0”, “90”, “180”, or “270”.}{}%
  ]
  \newdimen\@SPWIDTHUSED%
  \@SPWIDTHUSED=\dimexpr\@SPWIDTH-\thespine(margin,top)-\thespine(margin,bottom)\relax%
  %
  \begin{newpdflayout}[margin=0pt]{\@HT}{\@WD}
  %
  \thispagestyle{empty}%
  % \DEBUG{NOVATHESIS SPINE @SPWIDTH=\the\@SPWIDTH}%
  %
  % Lets start by calculating the total len of each box, 
  % the used len of each box (total minus margins),
  % and the accumulated len of the spine elements
  %
  % Keeps the accumulated len of the spine elements
  \@tempdimb=0pt%
  % Count the number of elements to be printed in the cover
  \newcount\@SPNELEM%
  \@SPNELEM=0\relax%
  %
  % Iterate the sipne elements
  \@for\myi:=\expanded{\thespine(order)}\do{% 
    % \DEBUG{NOVATHESIS SPINE calculating TEXT[\myi]}
    % Increment the counter of elements
    \advance\@SPNELEM 1\relax%
    % Calculate box len
    \@tempdima=\dimexpr\thespine(box,\myi,len)\relax%
    \spine(box,\myi,len):={\the\@tempdima}%
    % Accumulated len of the spine elements    
    \@tempdimb=\dimexpr\@tempdimb+\@tempdima\relax%
    % Calculate the used text len of the box (= total box len minus box margins)
    \datamatchtf[0pt]{\@boxml}{spine}({box,\myi,margin,left},{box,margin,left},{box,margin}){}{}%
    \datamatchtf[0pt]{\@boxmr}{spine}({box,\myi,margin,right},{box,margin,right},{box,margin}){}{}%
    \@tempdima=\dimexpr\@tempdima-\@boxml-\@boxmr\relax%
    \spine(box,\myi,usedlen):={\the\@tempdima}%
    % \DEBUG{TEXT[\myi,len]=\thespine(box,\myi,len)}
    % \DEBUG{TEXT[\myi,usedlen]=\thespine(box,\myi,usedlen)}
    % {TEXT[\myi,len]=\thespine(box,\myi,len)}\par
    % {TEXT[\myi,usedlen]=\thespine(box,\myi,usedlen)}\par
  }%
  %
  % Save the accumulated len of the spine elements 
  \newdimen\@SPLEN%
  \@SPLEN=\the\@tempdimb%
  % Claculate the total unused (empty) space between elements
  \newdimen{\@SPUNUSEDTOTAL}%
  \@SPUNUSEDTOTAL=\dimexpr\@SPMAXLEN-\@SPLEN-\thespine(margin,left)-\thespine(margin,right)\relax%
  % \typeout{\string\@SPMAXLEN-\string\@SPLEN-\string\thespine(margin,left)-\string\thespine(margin,right)=\the\@SPMAXLEN-\the\@SPLEN-\thespine(margin,left)-\thespine(margin,right)}\UNUSEDTOTAL
  % Claculate the unused (empty) space between evry two elements
  \newdimen{\@SPUNUSED}%
  \@SPUNUSED=\dimexpr\@SPUNUSEDTOTAL/(\@SPNELEM-1)\relax
  % {@SPWIDTH=\the\@SPWIDTH}\par
  % {@SPLEN=\the\@SPLEN}\par
  % {@SPUNUSEDTOTAL=\the\@SPUNUSEDTOTAL}\par%
  % {LEFTM=\the\dimexpr\thespine(margin,left)\relax}\par%
  % {RIGHTM=\the\dimexpr\thespine(margin,right)\relax}\par%
  % {PAPERLEN=\the\paperheight}\par%
  % {@SPNELEM=\the\@SPNELEM}\par%
  % {@SPUNUSED=\the\@SPUNUSED}\par%
  \newsabebox\@spinebox
  \begin{lrbox}{\@spinebox}
  \newlength\@BOXHT%
  \begin{tikzpicture}[remember picture, overlay, transform shape, rotate=\@SPANGLE,
                      xscale=\@SPXSCALE, xshift=\@SPXSHIFT,]
    \setlength{\fboxsep}{0pt}\setlength{\fboxrule}{0.5pt}%
    % iterate the cover elements and draw them
    \@for\myi:=\expanded{\thespine(order)}\do{%
      \datamatchtf[0pt]{\@boxml}{spine}
											({box,\myi,margin,left},{box,margin,left},{box,margin}){}{}%
      \datamatchtf[0pt]{\@boxmr}{spine}
											({box,\myi,margin,right},{box,margin,right},{box,margin}){}{}%
      \datamatchtf[0pt]{\@boxmt}{spine}
											({box,\myi,margin,top},{box,margin,top},{box,margin}){}{}%
      \datamatchtf[0pt]{\@boxmb}{spine}
											({box,\myi,margin,bottom},{box,margin,bottom},{box,margin}){}{}%
      \def\@boxcolback{tcbcolback}%
      \datamatchtf{\@boxcolbacki}{spine}({box,\myi,color,bg},{box,color,bg})
                    {\ifnotnone{\@boxcolbacki}{\def\@boxcolback{\@boxcolbacki}}}{}%
      \def\@boxcoltext{.}%
      \datamatchtf{\@boxcoltexti}{spine}({box,\myi,color,text},{box,color,text})
                    {\ifnotnone{\@boxcoltexti}{\def\@boxcoltext{\@boxcoltexti}}}{}%
      \ifoptioncontains{/novathesis/debug}{spine}{%
        \def\@boxrule{0.5pt}%
        \def\@boxcolframe{\@boxcoltext}%
        \def\@boxdebug{}%
      }{%
        \def\@boxrule{0pt}%
        \def\@boxdebug{frame empty}%
      }%
      % \typeout{SPINE \string\@SPCURPOSX=\the\@SPCURPOSX \string\thespine(box,\myi,len)=\thespine(box,\myi,len) \string\@SPUNUSED=\the\@SPUNUSED}\SPINE
      \node[inner sep=0pt, anchor=\@BOXANCHOR, %draw,
            % minimum width=\expanded{\thespine(box,\myi,usedlen)},
            % minimum height=\@SPWIDTHUSED,
            ]
        at ($(\@BOXPOSITION)+(\@SPCURPOSX,0)$) {%
                  \begin{tcolorbox}[
                          size=minimal, valign=center, halign=center,
                          width=\expanded{\thespine(box,\myi,usedlen)}, height=\@SPWIDTHUSED,
                          left=\@boxml, right=\@boxmr, top=\@boxmt, bottom=\@boxmb,
                          colback=\@boxcolback, coltext=\@boxcoltext,
                          boxrule=\@boxrule, colframe=\@boxcolframe,
                          \@boxdebug,
                          % tikz={rotate=30},
                  ]%
                    [\myi]
                  \end{tcolorbox}%
        };
      \@SPCURPOSX=\dimexpr\@SPCURPOSX
                    +(\thespine(box,\myi,len)+\@SPUNUSED)\relax%
    }
  \end{tikzpicture}
  \end{lrbox}
\end{newpdflayout}
\AddToHookNext{shipout/before}{\DiscardShipoutBox}
}


\endinput





















\newcommand{\@ntprintspine}{%x§
% If angle is 0 revere the order of the logos
\IfStrEqCase{\thespine(angle)}{%
    {0}{\@reverelist{\expanded{\thespine(logo)}}\@logoorder%
        \spine(logo):={\@logoorder}}%
  {180}{\spine(margin,left2):={\thespine(margin,left)}%
        \spine(margin,left):={\thespine(margin,right)}%
        \spine(margin,right):={\thespine(margin,left2)}%
        % \spine(box,logo,angle):={\number\numexpr\thespine(box,logo,angle)+180\relax}%
        \@reverelist{\expanded{\thespine(order)}}\spineorder%
        \spine(order):={\spineorder}}%
}[\CalssError{novathesis}{Invalid spine angle: \thespine(angle)! Should be wither “0” or “180”.}{}]


\@checkspinelen

% Increase box spacing if necessary
% Reduce default boxes length and keep given/forces boxes length 
\@tempdima=\dimexpr\paperheight-\@spinelen\relax%                             = remaining space to fill spine
\ifdim\@tempdima>0pt\relax%
  % spine FITS into paper height
  \@tempdima=\dimexpr\@tempdima/\@nBoxSep\relax%                              = new box sep size
  % \DEBUG{NEW BOXSEP=\the\@tempdima}
  \spine(boxsep):={\the\@tempdima}%                                           = set new boxsep
\else\ifdim\@tempdima<0pt\relax%
  % spine DOES NOT FIT into paper height
    \ClassError{novathesis}{Spine is \the\@tempdima\space too long: \the\@spinelen\space instead of \the\paperheight}
    {Get some insight with “fgrep SPINELEN *.log”}{}
\fi\fi%
  % % SPINE boxes are to large for the spine size, decrease spacing in the not-explicitly defined boxes
  % \@tempdima=\dimexpr\paperheight-\@spinefixedlen\relax
  % % \showthe\@tempdima
  % \@tempdimb=\dimexpr\@spinelen-\@spinefixedlen\relax
  % % \showthe\@tempdimb
  % % \StrGobbleRight{\the\@tempdimb}{2}[\@SPVAR]
  % \DEBUG{DL 1=[\the\@tempdima] 2=[\the\@tempdimb]}\AAAA
  % \edef\@spinevarratio{\DivideLengths{\@tempdima}{\@tempdimb}}
  % % \show\@spinevarratio
  % \@for\myi:=\expanded{\thespine(order)}\do{%
  %   \ifdatadefined{spine}(box,\myi,len){%
  %     % Fixed box length, do not touch
  %   }{%
  %     % Variable box length, apply ratio
  %   \@tempdima=\dimexpr\thespine(box,\myi,len)\relax%
  %   % \DEBUG{OLD SPINEBOXLEN[\myi]=\the\@tempdima}
  %   \@tempdima=\dimexpr \@spinevarratio\@tempdima\relax
  %   % \DEBUG{NEW SPINEBOXLEN[\myi]=\the\@tempdima}
  %   \spine(box,\myi,len):={\the\@tempdima}
  %   }%
  % }%

% \displayspinealyout
\@checkspinelen
% \DEBUG{PAPER HEIGHT=\the\paperheight}
% \DEBUG{SPINELEN[FINAL]=\the\@spinelen}
% \PAUSETHIS

% Calculate box[lef], box[len], box[right] if undefined
\@tempdima=\dimexpr\thespine(margin,left)-\thespine(boxsep)\relax%
\@for\myi:=\expanded{\thespine(order)}\do{
  \ifdatadefined{spine}(box,\myi,left){%
    \@tempdima=\thespine(box,\myi,left)%
  }{%
    \@tempdima=\dimexpr\@tempdima+\thespine(boxsep)\relax%
  }%
  \spine(box,\myi,left):={\the\@tempdima}%
  \@tempdima=\dimexpr\@tempdima+\thespine(box,\myi,len)\relax%
  \spine(box,\myi,right):={\the\@tempdima}
  % \DEBUG{BOX[\myi,left]=\thespine(box,\myi,left)}
  % \DEBUG{BOX[\myi,len]=\thespine(box,\myi,len)}
  % \DEBUG{BOX[\myi,right]=\thespine(box,\myi,right)}
}%

\@for\myi:=\expanded{\thespine(order)}\do{%
  % \DEBUG{TEXT[\myi]}
  \datamatchtf[0pt]{\@boxml}{spine}({box,\myi,margin,left},{box,margin,left}){}{}%
  \datamatchtf[0pt]{\@boxmr}{spine}({box,\myi,margin,right},{box,margin,right}){}{}%
  % \DEBUG{TEXT[\myi] [\@boxml] [\@boxmr]}
  \@tempdima=\dimexpr\thespine(box,\myi,len)\relax%
  \spine(box,\myi,len):={\the\@tempdima}%
  \@tempdima=\dimexpr\@tempdima-\@boxml-\@boxmr\relax%
  \spine(box,\myi,usedlen):={\the\@tempdima}%
  % \DEBUG{TEXT[\myi,len]=\thespine(box,\myi,len)}
  % \DEBUG{TEXT[\myi,usedlen]=\thespine(box,\myi,usedlen)}
}
\ifoptionequal{/novathesis/spine/layout}{none}{}{%
  \parindent=0pt%
  \sffamily%
  \linespread{0.85}%
  \normalsize%
  \ifdim\option{/novathesis/spine/width}=0pt\relax%
    \@setlength{\@SPWIDTH}{0.05mm * (\thelastsheet+1)}%
    % \DEBUG{NOVATHESIS spine width for \thelastsheet\space pages is \the\@SPWIDTH!}%
    \ifdim\@SPWIDTH < 6mm\relax% Force book spine to be at least 6mm
      % \DEBUG{NOVATHESIS spine width was \the\@SPWIDTH, forcing to 6mm!}%
      \@setlength{\@SPWIDTH}{6mm}%
    \fi%
  \else%
    \@setlength{\@SPWIDTH}{\option{/novathesis/spine/width}}%
    % \DEBUG{NOVATHESIS spine width user forced by user to \the\@SPWIDTH!}%
  \fi%
  % \DEBUG{NOVATHESIS \string\@SPWIDTH=\the\@SPWIDTH}%
  \@setlength{\@thespinewidth}
             {\dimexpr\@SPWIDTH-\thespine(margin,top)-\thespine(margin,bottom)\relax}%
  \def\@fbratio{9999}%
  \@for\myi:=\expanded{\thespine(order)}\do{%
    \IfStrEq{\myi}{title}{%
      \fitboxratio{@\myi RT}{\thespine(box,\myi,usedlen)}{\@thespinewidth}{\thespine(\myi)}%
      \fitboxratio{@\myi 2RT}{\thespine(box,\myi,usedlen)}{\@thespinewidth}{\def\\{ }\thespine(\myi)}%
      \pgfmathparse{\csuse{@\myi RT}}%
      \edef\@tone{\pgfmathresult}%
      \pgfmathparse{\csuse{@\myi 2RT}}%
      \edef\@ttwo{\pgfmathresult}%
      % \DEBUG{T1=\@tone\space T2=\@ttwo}\AAAAA%
      \ifdim\@tone pt < \@ttwo pt\relax%
        % \BBBBBBB%
        \spine(\myi):={\def\\{ }\thespine(\myi)}%
      \fi%
    }{}%\ASDSDDSAS
    \IfSubStr{,\thespine(order,widthskip),}{,\myi,}{}{%
      \fitboxratio{@\myi RT}{\thespine(box,\myi,usedlen)}{\@thespinewidth}{\thespine(\myi)}%
      % \DEBUG{NOVATHESIS RATIO[\myi]=\csuse{@\myi RT}}%
      \pgfmathparse{min(\@fbratio,\csuse{@\myi RT})}%
      % \DEBUG{NOVATHESIS RATIO MIN(\@fbratio,\csuse{@\myi RT})=\pgfmathresult}%
      \edef\@fbratio{\pgfmathresult}%
    }%
  }%
  % \DEBUG{NOVATHESIS RATIO=\@fbratio}
  \currentpdfbookmark{\thebkmstring(spine)}{thespine}%
  \ifoptionequal{/novathesis/spine/layout}{trim}{%
    \stockwidth=\stockheight%
    \stockheight=\@SPWIDTH%
  }{\ifoptionequal{/novathesis/spine/layout}{notrim}{%
    \let\oldstockwidth=\stockwidth
    \stockwidth=\stockheight%
    \stockheight=21cm%
  }{%
    \ClassError{novathesis}{Unknown page dimensions for “spine/layout=\option{/novathesis/spine/layout}”}
  }}%
  \paperwidth=\stockwidth%
  \paperheight=\stockheight%
  \setstocksize{\stockheight}{\stockwidth}%
  \settrimmedsize{\stockheight}{\stockwidth}{*}%
  % \paperheight=\@SPWIDTH%
  \setlrmarginsandblock{0pt}{0pt}{*}%
  \setulmarginsandblock{0pt}{*}{1}%
  \setheaderspaces{0pt}{*}{*}%
  \footskip = 0pt
  \checkandfixthelayout[fixed]%
  \ifluatex%
  \pagewidth=\paperwidth%
  \pageheight=\paperheight% \pageheight=3in
  \else%
  \pdfpagewidth=\paperwidth%
  \pdfpageheight=\paperheight% \pageheight=3in
  \fi%
  \thispagestyle{empty}%
  \NTRunHook{spine/pre}%
  % \PAUSETHIS
 \ifoptionequal{/novathesis/spine/layout}{trim}
               {\@tempdima=0pt}
               {\@tempdima=\dimexpr(\stockheight-\@SPWIDTH)/2\relax}%
  \begin{tikzpicture}[remember picture, overlay,yscale=-1,yshift=-10.75pt+\@tempdima]%
    % print spine bg color IF DEFINED
    \datamatchtf{\arg}{spine}(%
                      {\@DOCTYPE,bg,color},%
                      {\@DOCCLASS,bg,color},%
                      {bg,color}%
    ){\ifnotnone{\arg}{\pagecolor{\arg}}}{%
      \ClassError{novathesis}{Undefined spine “bg,color”}{}%
    }%
    % print frame IF DEFINED
    \ifoptionequal{/novathesis/spine/layout}{notrim}{%
      \datamatchtf{\arg}{spine}(%
                        {\@DOCTYPE,frame,color},%
                        {\@DOCCLASS,frame,color},%
                        {frame,color}%
      ){\ifnotnone{\arg}{\draw [color=\arg] (0,0) rectangle (\paperwidth-0.4pt,\@SPWIDTH-0.4pt);}}{%
        \ClassError{novathesis}{Undefined spine “frame,color”}{}%
      }%
    }{}%
    % print bg image IF DEFINED
    \datamatchtf{\arg}{thesiscover}({\@DOCTYPE,spine,image},{\@DOCCLASS,spine,image},{spine,image}){%
      \ifnotnone{\arg}{%
        \node[inner sep=0] at (current page.center)
                {\includegraphics[width=\paperheight,height=\paperwidth,
                                  angle=\number\numexpr\thespine(angle)-90\relax]{\arg}};
      }}{%
          \datamatchtf{\arg}{spine}(%
                        {\@DOCTYPE,image},%
                        {\@DOCCLASS,image},%
                        {image},%
      ){%
          \ifnotnone{\arg}{%
            \node[inner sep=0] at (current page.center)
                    {\includegraphics[width=\paperheight,height=\paperwidth,
                                      angle=\number\numexpr\thespine(angle)-90\relax]{\arg}};
      }}{%
        \ClassError{novathesis}{Undefined spine “image”}{}%
      }%
    }%
    \@for\myi:=\expanded{\thespine(order)}\do{%
      \datamatch{\@boxcolor}{spine}({box,\myi,bg,color},{box,color,bg})%
      \node[rectangle,
            inner sep = 0pt,
            anchor = north west,
            draw, color = red, draw opacity=\@spineboxdrawopacity,
            fill = {\@boxcolor},
            minimum width = \expanded{\thespine(box,\myi,len)},
            minimum height = \@thespinewidth,
      ] (r\myi) at (\thespine(box,\myi,left),\expanded{\thespine(margin,top)}) {};
      \datamatchtf{\@align}{spine}({box,\myi,align},{\myi,align},{text,align}){}{%
        \ClassError{novathesis}{Invalid spine text alignment for “\myi”}{}%
      }%
      \IfStrEqCase{\@align}{%
        {l}{\node [inner sep=0, anchor=west] at (r\myi.west)
              {\printspinebox{\myi}{\@fbratio}};}%
        {c}{\node [inner sep=0, anchor=center] at (r\myi)
              {\printspinebox{\myi}{\@fbratio}};}%
        {r}{\node [inner sep=0, anchor=east] at (r\myi.east)
              {\printspinebox{\myi}{\@fbratio}};}%
      }%
    }%
  \end{tikzpicture}%
  \ifoptioncontains{/novathesis/DEBUG}{cover}{%
    \NTRunHook{cover/spine/grid/pre}%
    \DEBUGgrid%
    \NTRunHook{cover/spine/grid/post}%
  }{}%
}%
}

\newcommand{\printspinebox}[2]{%
  % 1=spine box name
  % 2=ratio
  \datamatchtf{\@item}{spine}(%
                    {#1,\@DOCCLASS},%
                    {#1,\@DOCTYPE},%
                    {#1}%
  ){}{\ClassError{novathesis}{Undefined spine element: #1}{}}%
  \datamatchtf{\@angle}{spine}(%
                    {box,#1,\@DOCTYPE,angle},%
                    {box,#1,\@DOCCLASS,angle},%
                    {box,#1,angle},%
                    {#1,\@DOCTYPE,angle},%
                    {#1,\@DOCCLASS,angle},%
                    {#1,angle}%
  ){}{\def\@angle{\thespine(angle)}}%
  \datamatchtf{\@scale}{spine}(%
                    {box,#1,\@DOCTYPE,scale},%
                    {box,#1,\@DOCCLASS,scale},%
                    {box,#1,scale},%
                    {#1,\@DOCTYPE,scale},%
                    {#1,\@DOCCLASS,scale},%
                    {#1,scale}%
  ){}{\def\@scale{1}}%
  \datamatchtf{\@raise}{spine}(%
                    {box,#1,\@DOCTYPE,raise},%
                    {box,#1,\@DOCCLASS,raise},%
                    {box,#1,raise},%
                    {#1,\@DOCTYPE,raise},%
                    {#1,\@DOCCLASS,raise},%
                    {#1,raise}%
  ){}{\def\@raise{0pt}}%
  % \DEBUG{L=[\thespine(logo)] IT(#1)=[\@item]}\AAAA
  % \DEBUG{PRINT BOX #1  ITEM=\@item}%
  % \DEBUG{PRINT BOX #1 ANGLE=\@angle}%
  % \DEBUG{PRINT BOX #1 SCALE=\@scale}%
  % \DEBUG{PRINT BOX #1 RAISE=\@raise}%
  \IfStrEq{#1}{logo}{%
    % IMAGE
    \IfStrEq{\@item}{none}{}{%
      \edef\@lspace{\thespine(box,logo,margin,sep)}%
      \edef\@lwidth{\thespine(box,logo,usedlen)}%
      \edef\@lheight{\@thespinewidth}%
      % \DEBUG{W=\@lwidth\space H=\the\@lheight\space S=\@lspace}\FILE
      \setbox1=\hbox{\hspace*{-\@lspace}}%
      \@for\myj:={\@item}\do{%
        \StrCut{\myj}{/}\@@lspace\@lfile%
        % \DEBUG{LS=\@@lspace\space F=\@lfile}\FILE
        \IfIsDim{\@@lspace}{}{\edef\@lfile{\@@lspace/\@lfile}\edef\@@lspace{0pt}}%
        \StrCut{\@lfile}{/}\@lfile\@langle%
        % \DEBUG{F=\@lfile\space A=\@langle}\FILE
        \StrCut{\@langle}{/}\@langle\@lscale%
        % \DEBUG{F=\@lfile\space A=\@langle\space S=\@lscale}\FILE
        \IfStrEq{\@langle}{}{\edef\@langle{\@angle}}{}%
        \IfStrEq{\@lscale}{}{\edef\@lscale{\@scale}}{}%
        % \DEBUG{F=\@lfile\space A=\@langle\space S=\@lscale}\FILE
        \setbox0=\hbox{\includegraphics[height=\@thespinewidth,angle=\number\numexpr\@langle-90\relax,
                                        scale=\@lscale,origin=c]{\@lfile}}%
        \setbox1=\hbox{\minipage{\wd1}\box1\endminipage\hspace*{\@lspace}\minipage{\wd1}\box0\endminipage\hspace{\@@lspace}}%
      }
      \ifdim\dimexpr\wd1\relax>\@lwidth\relax%
        \setbox1=\hbox{\resizebox*{\@lwidth}{!}{\box1}}%
      \fi%
      \ifdim\dimexpr\ht1+\dp1\relax>\@lheight\relax%
        \setbox1=\hbox{\rotatebox{-90}{\box1}}%
        \setbox1=\hbox{\resizebox*{\@lheight}{!}{\box1}}%
        \setbox1=\hbox{\rotatebox{90}{\box1}}%
      \fi%
      \box1%
    }%
  }{%
    % TEXT
    \rotatebox[origin=c]{\@angle}{%
    \scalebox{\@fbratio}{%
      \datamatchtf{\arg}{spine}({box,text,color},{text,color}){\color{\arg}}{}%
      \ifdatadefined{spine}(#1,\@UNIV/\@SCHL){%
        \tabular{@{}c@{}}\thespine(#1,\@UNIV/\@SCHL)\endtabular%
      }{%
        \thespine(#1,font)\tabular{@{}c@{}}\thespine(#1)\endtabular%
      }%
    }%
    }%
  }%
  % \PAUSETHIS
}

